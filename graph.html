<!doctype html>
<html>
	<head>
		<title>Analisis</title>
		<script src="js/Chart.js"></script>
    <script src="js/Chart.StackedBar.js"></script>
		<meta name = "viewport" content = "initial-scale = 1, user-scalable = no">
		<script src="js/sql.js"></script>
		<style>
			canvas{
			}
		</style>
	</head>
	<body>
		<canvas id="canvas" height="450" width="600"></canvas>
  </body>
</html>
<script>
var xhr = new XMLHttpRequest();
xhr.open('GET', 'db/_neighbours.db', true);
xhr.responseType = 'arraybuffer';

xhr.onload = function(e) {
  var uInt8Array = new Uint8Array(this.response);
  var db = new SQL.Database(uInt8Array);
  var alive = [];
  var failed = [];
  var label = [];
  var contents = db.exec("select timestamp,status, count(status) from neigh group by timestamp, status;");
  // contents is now [{columns:['col1','col2',...], values:[[first row], [second row], ...]}]
  console.log(contents);
  values =  contents[0].values
  var l = 0
  var stacked_values = [];
  for (i in values){
      console.log(i)
      if (values[i][1] == "alive")
        stacked_values[0] = values[i][2];
      else
        stacked_values[1] = values[i][2];
      if (l !=  values[i][0]) {
        if (l != 0) {
            alive.push(stacked_values);
        }
        l =  values[i][0];
        var date = new Date(l*1000);
        var hours = date.getHours();
        var minutes = "0" + date.getMinutes();
        var seconds = "0" + date.getSeconds();
        var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
        label.push(formattedTime);
      }
      alive.push(stacked_values);
  }
  var ChartData = {
    labels : label,
		datasets : [
			{
				fillColor : "rgba (220,220,120,0.5)",
				strokeColor : "rgba(220,220,120,1)",
				pointColor : "rgba(220,220,120,1)",
				pointStrokeColor : "#fff",
				data : failed
			},
			{
				fillColor : "rgba(151,187,205,0.5)",
				strokeColor : "rgba(151,187,205,1)",
				pointColor : "rgba(151,187,205,1)",
				pointStrokeColor : "#fff",
				data : alive
			}
		]

	}

//	var myLine = new Chart(document.getElementById("canvas").getContext("2d")).Line(lineChartData);
new Chart(document.getElementById("canvas").getContext("2d")).Bar(ChartData, {
    stacked: true
});
};
xhr.send();
</script>
